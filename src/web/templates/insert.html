{% extends "base.html" %}

{% block title %}Insert - Resonanz{% endblock %}

{% block content %}
    <h2 class="mb-4">Enter Tenant Information</h2>
    <form id="insertForm" class="mb-3">
        <div class="mb-3">
            <label for="tenantName" class="form-label">Tenant Name</label>
            <input type="text" class="form-control" id="tenantName" placeholder="Enter tenant name" required />
        </div>
        <div class="mb-3">
            <label for="tenantAddress" class="form-label">Tenant Address</label>
            <input type="text" class="form-control" id="tenantAddress" placeholder="Enter tenant address" required />
        </div>
        <div class="mb-3">
            <label for="csvFile" class="form-label">Upload CSV File</label>
            <input type="file" class="form-control" id="csvFile" accept=".csv" />
        </div>
        <button type="button" id="insertBtn" class="btn btn-primary">Submit</button>
    </form>

    <div id="progressBar" style="display:none; width: 100%; background-color: grey;">
        <div id="progressBarStatus" style="height: 30px; width: 0%; background-color: green;"></div>
    </div>

    <script>
        $(document).ready(function() {
            $('#insertBtn').click(function() {
                const tenantName = $('#tenantName').val();
                const tenantAddress = $('#tenantAddress').val();

                if (tenantName && tenantAddress) {
                    $.ajax({
                        url: '/insert/_tenant',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ name: tenantName, address: tenantAddress }),
                        success: function(response) {
                            newToast("Tenant information added.", "#5cb85c");
                        },
                        error: function(xhr) {
                            newToast("Error - " + xhr.status + ': ' + xhr.statusText, "#dc3545");
                        }
                    });
                    $('#tenantName').val('');
                    $('#tenantAddress').val('');
                }

                const file = $('#csvFile')[0].files[0];
                if (file) {
                    uploadFile(file);
                }
            });
        });

        function uploadFile(file) {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/insert/_batch', true);

            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    $('#progressBar').show();
                    $('#progressBarStatus').css('width', percentComplete + '%');
                }
            };

            xhr.onload = function() {
                if (xhr.status === 200) {
                    newToast("File uploaded successfully.", "#5cb85c");
                } else {
                    newToast("Error - File upload failed.", "#dc3545");
                }
                $('#progressBar').hide();
                $('#progressBarStatus').css('width', '0%');
            };

            const formData = new FormData();
            formData.append('file', file);
            xhr.send(formData);
        }

        function newToast(message, color) {
            Toastify({
                text: message,
                duration: 3000,
                close: true,
                gravity: "top",
                position: 'right',
                backgroundColor: color,
                stopOnFocus: true
            }).showToast();
        }
    </script>
{% endblock %}
